<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ficha Interativa - Alfa: O Despertar</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  /* Variáveis de cor e layout, baseadas no Alfa 6 original */
  :root { --bg:#121212; --card:#1e1e1e; --muted:#9aa0a6; --acc:#ffd700; --ok:#00d084; --warn:#ffb300; --bad:#ff5252; --text:#f2f2f2; --input-bg:#111; --border-color:#333; }
  * { box-sizing: border-box; }
  body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui, Arial, sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-osx-smoothing: grayscale; }
  header { padding:14px 16px; background:#0d0d0d; position:sticky; top:0; z-index:10; border-bottom:1px solid #222; display: flex; justify-content: space-between; align-items: center; }
  header h1 { margin:0; font-size:18px; color:var(--acc); text-align:center; flex-grow: 1; }
  .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
  }
  .header-content a {
    text-decoration: none;
    color: #fff;
    background-color: #4a5568;
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    transition: all 0.3s ease;
  }
  .header-content a:hover {
    background-color: #fbd38d;
    color: #2d3748;
  }
  main { padding:12px; display:grid; gap:12px; max-width:900px; margin:0 auto; }
  .card { background:var(--card); border:1px solid #2a2a2a; border-radius:12px; padding:12px; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .col { flex:1; min-width:140px; }
  label { font-size:12px; color:var(--muted); display:block; margin-bottom:4px; }
  input, select, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid var(--border-color); background:var(--input-bg); color:var(--text); font-size:14px; }
  textarea { min-height:70px; resize:vertical; }
  input[type=number] { -moz-appearance: textfield; }
  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .btn { display:inline-flex; align-items:center; justify-content:center; gap:6px; border:0; border-radius:10px; padding:10px 12px; font-weight:700; background:var(--acc); color:#000; cursor:pointer; transition: background-color 0.2s, transform 0.1s; }
  .btn:hover { background: #ffea70; }
  .btn:active { transform: scale(0.98); }
  .btn.ghost { background:#2b2b2b; color:var(--text); border:1px solid #3a3a3a; }
  .btn.danger { background:var(--bad); color:#fff; }
  .btn.ok { background:var(--ok); color:#000; }
  .btn.warn { background:var(--warn); color:#000; }
  .btn.ghost:hover { background: #3c3c3c; }
  .counter { display:flex; align-items:center; gap:8px; }
  .counter .val { min-width:36px; text-align:center; font-weight:700; }
  .tag { padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; display:inline-block; }
  .tag.ok { background:rgba(0,208,132,.15); color:var(--ok); border:1px solid rgba(0,208,132,.35); }
  .tag.warn { background:rgba(255,179,0,.15); color:var(--warn); border:1px solid rgba(255,179,0,.35); }
  .tag.bad { background:rgba(255,82,82,.15); color:var(--bad); border:1-px solid rgba(255,82,82,.35); }
  .list { display:grid; gap:8px; }
  .item { padding:10px; border:1px solid #333; border-radius:10px; background:#161616; }
  .item h4 { margin:0 0 6px 0; font-size:15px; }
  .muted { color:var(--muted); font-size:12px; }
  .dice-area { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .die { width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:10px; background:#0f0f0f; border:1px solid #2b2b2b; font-weight:800; font-size:16px; cursor:pointer; transition: transform 0.1s; }
  .die:hover { transform: translateY(-2px); }
  .die.six { border-color:var(--ok); }
  .die.one { border-color:var(--bad); }
  .result { margin-top:8px; padding:10px; border-radius:10px; background:#101010; border:1px solid #2a2a2a; }
  .result h3 { margin:0 0 6px 0; }
  .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; }
  .sep { height:1px; background:#2a2a2a; margin:8px 0; }
  .small { font-size:12px; }
  .right { margin-left:auto; }
  .wrap { flex-wrap:wrap; }
  .profile-pic { width: 100px; height: 100px; border-radius: 8px; object-fit: cover; margin-right: 12px; }
  
  /* Novos estilos para os modais */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 1000;
    display: none; justify-content: center; align-items: center;
  }
  .modal-content {
    background: var(--card); border: 1-px solid #4a4a4a; border-radius: 12px;
    padding: 16px; width: 90%; max-width: 500px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  .modal-content h3 { margin-top: 0; }
  
  /* Modal de características fixo */
  .modal-with-scroll .modal-content {
    max-height: 80vh;
    overflow-y: auto;
  }
  
  /* Toggle Switch */
  .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
  .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: var(--ok); }
  input:checked + .slider:before { transform: translateX(26px); }
  .slider-text { position: absolute; color: white; font-size: 10px; line-height: 34px; width: 100%; text-align: center; }

  /* Image Cropper */
  .image-cropper-container {
    width: 300px;
    height: 300px;
    position: relative;
    overflow: hidden;
    margin: 0 auto 16px auto;
    border: 2px solid white; /* Moldura para indicar o enquadramento */
    border-radius: 8px;
  }
  .image-cropper-container img {
    position: absolute;
    cursor: grab;
    touch-action: none; /* Previne o scroll em mobile */
    /* FIX: Ensure image fills container and is zoomable */
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .image-cropper-container img.is-dragging {
    cursor: grabbing;
  }

  .move-btn-group {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(3, 1fr);
      gap: 5px;
      margin-top: 10px;
  }

  .move-btn {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 30px;
      height: 30px;
      background: #2b2b2b;
      color: var(--text);
      border: 1px solid #3a3a3a;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      user-select: none;
  }
  .move-btn:hover { background-color: #3c3c3c; }
  .move-btn:active { transform: scale(0.95); }
  .move-btn.up { grid-area: 1 / 2 / 2 / 3; }
  .move-btn.left { grid-area: 2 / 1 / 3 / 2; }
  .move-btn.center { grid-area: 2 / 2 / 3 / 3; }
  .move-btn.right { grid-area: 2 / 3 / 3 / 4; }
  .move-btn.down { grid-area: 3 / 2 / 4 / 3; }
  
  /* Styles for collapsible trees */
  .arvore-header {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
  }
  .arvore-header h3 {
      margin: 0;
      flex: 1;
  }
  .arvore-header .toggle-icon {
      font-size: 1.5rem;
      transition: transform 0.2s;
  }
  .arvore-header.collapsed .toggle-icon {
      transform: rotate(-90deg);
  }
  .arvore-content {
      overflow: hidden;
      transition: all 0.3s ease-in-out;
  }
  .arvore-content.collapsed {
      max-height: 0;
      padding: 0;
      opacity: 0;
      margin-top: 0;
      pointer-events: none;
  }
</style>
</head>
<body>
<header>
    <div class="header-content">
        <h1>Ficha Interativa - Alfa: O Despertar</h1>
        <a href="index.html" class="nav-button">Voltar ao Início</a>
    </div>
</header>
<main id="ficha-geral">

  <!-- Modais -->
  <div id="alert-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 id="alert-title"></h3>
      <p id="alert-text"></p>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ok" onclick="hideAlertMessage()">Fechar</button>
      </div>
    </div>
  </div>

  <div id="caracteristica-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>Escolha uma Característica</h3>
      <p class="muted small">Você obteve um Sucesso Crítico com uma habilidade de Nível 3 ou superior. Escolha uma Característica para adicionar a ela.</p>
      <div id="caracteristica-options" class="list" style="margin-top: 10px;"></div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ghost" onclick="cancelarEscolha()">Cancelar</button>
      </div>
    </div>
  </div>
  
  <div id="manual-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>Ferramentas Manuais</h3>
      <p class="muted small">Selecione uma árvore e a ação desejada.</p>
      <div class="col" style="margin-bottom: 12px;">
        <label for="manual_arvore">Selecionar Árvore</label>
        <select id="manual_arvore" onchange="checkManualOptions()"></select>
      </div>
      <div class="actions" id="manual-options" style="display: none;">
        <button class="btn ok" id="btn-add-level" onclick="addLevelManually()">Adicionar Nível</button>
        <button class="btn ok" id="btn-add-carac" onclick="openManualCaracModal()">Adicionar Característica</button>
      </div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ghost" onclick="hideManualModal()">Cancelar</button>
      </div>
    </div>
  </div>
  
  <div id="arvore-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Nova Árvore de Habilidade</h3>
        <p class="muted small">Escolha uma categoria para a nova árvore.</p>
        <div class="list" id="arvore-options" style="margin-top: 10px;">
          <button class="btn ok" onclick="addArvoreFinal('Ataque', 'Ataque')">Ataque</button>
          <button class="btn ok" onclick="addArvoreFinal('Defesa', 'Defesa')">Defesa</button>
          <button class="btn ok" onclick="addArvoreFinal('Suporte', 'Suporte')">Suporte</button>
        </div>
        <div class="sep"></div>
        <div class="col" style="margin-top: 12px;">
            <label for="arvore_nome_custom">Nome da Árvore Adicional</label>
            <input id="arvore_nome_custom" placeholder="Ex: Magia Negra" />
        </div>
        <div class="actions" style="margin-top: 12px;">
            <button class="btn" onclick="addArvoreFinal('Adicional', L('arvore_nome_custom').value)">Adicionar Árvore</button>
            <button class="btn ghost" onclick="hideArvoreModal()">Cancelar</button>
        </div>
    </div>
  </div>
  
  <div id="manual-carac-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>Adicionar Característica</h3>
      <p class="muted small">Selecione uma característica para a habilidade.</p>
      <div class="col" style="margin-bottom: 12px;">
          <label for="manual_arvore_carac">Selecionar Árvore</label>
          <select id="manual_arvore_carac" onchange="renderManualCaracOptions()"></select>
      </div>
      <div class="col" style="margin-bottom: 12px;">
          <label for="manual_hab_carac">Selecionar Habilidade</label>
          <select id="manual_hab_carac" onchange="renderManualCaracOptions()"></select>
      </div>
      <div id="manual-carac-options"></div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ghost" onclick="hideManualCaracModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Novo modal para exibir todas as características -->
  <div id="all-caracteristicas-modal" class="modal-overlay modal-with-scroll">
    <div class="modal-content">
      <h3>Características Disponíveis</h3>
      <div id="all-caracteristicas-list" class="list" style="margin-top: 10px;"></div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ok" onclick="hideAllCaracteristicasModal()">Fechar</button>
      </div>
    </div>
  </div>

  <div id="xp-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>Adicionar <span id="xp-value"></span> XP</h3>
      <p class="muted small">Selecione o motivo pelo qual você ganhou XP.</p>
      <div id="xp-reason-buttons" class="list" style="margin-top: 10px;">
        <button class="btn ok" onclick="addXpWithReason('Derrotar Monstros: Pequeno')">Derrotar Monstros (Pequeno)</button>
        <button class="btn ok" onclick="addXpWithReason('Derrotar Monstros: Médio')">Derrotar Monstros (Médio)</button>
        <button class="btn ok" onclick="addXpWithReason('Completar Missão: Principal')">Completar Missão (Principal)</button>
        <button class="btn ok" onclick="addXpWithReason('Completar Missão: Secundária')">Completar Missão (Secundária)</button>
        <button class="btn ok" onclick="addXpWithReason('Interpretação Memorável')">Uso Criativo de Habilidade</button>
        <button class="btn ok" onclick="addXpWithReason('Uso Criativo de Habilidade')">Interpretação Memorável</button>
      </div>
      <div style="margin-top: 12px;">
        <label for="xp-other-reason">Outro (especifique)</label>
        <input id="xp-other-reason" placeholder="Ex.: Enigma resolvido" />
      </div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ok" onclick="addXpWithReason(L('xp-other-reason').value)">Adicionar</button>
        <button class="btn ghost" onclick="hideXpModal()">Cancelar</button>
      </div>
    </div>
  </div>
  <div id="xp-history-modal" class="modal-overlay">
    <div class="modal-content">
        <h3>Histórico de XP</h3>
        <div id="xp-history-list" class="list" style="margin-top: 10px;"></div>
        <div class="actions" style="margin-top: 12px;">
            <button class="btn ok" onclick="hideXpHistoryModal()">Fechar</button>
      </div>
    </div>
  </div>

  <div id="edit-item-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>Editar Item</h3>
      <div id="edit-item-fields">
        <div>
          <label for="edit_nome">Nome</label>
          <input id="edit_nome" />
        </div>
        <div>
          <label for="edit_lvl">Nível</label>
          <input id="edit_lvl" type="number" min="1" max="6" />
        </div>
        <div>
          <label for="edit_usos">Usos</label>
          <input id="edit_usos" type="number" min="0" />
        </div>
        <div>
          <label for="edit_bonus">Bônus (+xD6)</label>
          <input id="edit_bonus" type="number" min="0" />
        </div>
        <div style="margin-top: 10px;">
          <label for="edit_fx">Efeito</label>
          <textarea id="edit_fx"></textarea>
        </div>
        <div style="margin-top: 10px;">
          <label for="arvore_vinculada_edit">Vincular a Árvore</label>
          <select id="arvore_vinculada_edit"></select>
        </div>
      </div>
      <div class="actions" style="margin-top: 12px;">
        <button class="btn ok" onclick="salvarEdicaoItem()">Salvar</button>
        <button class="btn ghost" onclick="hideEditItemModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="image-cropper-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <h3>Ajustar Foto</h3>
        <div class="image-cropper-container">
            <img id="image-to-crop" src="" alt="Imagem para recortar">
        </div>
        <div class="actions" style="margin-top: 12px; align-items: center;">
            <div class="move-btn-group" style="margin-right: 12px;">
                <button class="move-btn up" onmousedown="startMove(0, -1)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startMove(0, -1)" ontouchend="stopMove()">&#x25B2;</button>
                <button class="move-btn left" onmousedown="startMove(-1, 0)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startMove(-1, 0)" ontouchend="stopMove()">&#x25C0;</button>
                <button class="move-btn right" onmousedown="startMove(1, 0)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startMove(1, 0)" ontouchend="stopMove()">&#x25B6;</button>
                <button class="move-btn down" onmousedown="startMove(0, 1)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startMove(0, 1)" ontouchend="stopMove()">&#x25BC;</button>
            </div>
            <div class="row">
                <button class="btn" id="zoom-out-btn" onmousedown="startZoom(-0.1)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startZoom(-0.1)" ontouchend="stopMove()">-</button>
                <button class="btn" id="zoom-in-btn" onmousedown="startZoom(0.1)" onmouseup="stopMove()" onmouseleave="stopMove()" ontouchstart="startZoom(0.1)" ontouchend="stopMove()">+</button>
            </div>
            <div class="row" style="margin-top: 12px;">
                <button class="btn ok" onclick="cropAndSaveImage()">Salvar</button>
                <button class="btn danger" onclick="cancelCrop()">Cancelar</button>
            </div>
        </div>
    </div>
  </div>

  <!-- PERSONAGEM -->
  <section class="card" id="sec-personagem">
    <div class="row">
      <div class="col" style="flex: 0 0 120px;">
          <label for="p_foto_upload">Foto de Perfil</label>
          <img id="p_foto_img" src="https://placehold.co/100x100" class="profile-pic" alt="Foto de Perfil">
          <input type="file" id="p_foto_upload" style="display: none;" accept="image/*">
          <div class="row" style="margin-top: 8px;">
            <label for="p_foto_upload" class="btn ghost" style="text-align:center; cursor:pointer; flex: 1;">Upload</label>
            <button class="btn ghost" id="btn-edit-photo" onclick="editProfilePic()">Editar</button>
          </div>
      </div>
      <div class="col">
        <label for="p_nome">Nome</label>
        <input id="p_nome" placeholder="Nome do Personagem" onchange="updateCharacterDetails()" />
        <label for="p_raca" style="margin-top: 8px;">Raça</label>
        <input id="p_raca" placeholder="Ex.: Humano" onchange="updateCharacterDetails()" />
        <label for="p_classe" style="margin-top: 8px;">Classe</label>
        <input id="p_classe" placeholder="Ex.: Guerreiro" onchange="updateCharacterDetails()" />
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div class="col">
        <label for="p_nivel">Nível</label>
        <select id="p_nivel" onchange="updateCharacterLevel()">
          <option value="1">Nível 1</option>
          <option value="2">Nível 2</option>
          <option value="3">Nível 3</option>
          <option value="4">Nível 4</option>
          <option value="5">Nível 5</option>
          <option value="6">Nível 6</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div class="col">
        <label for="p_pv">PV</label>
        <div class="counter">
          <button class="btn ghost" onclick="inc('p_pv',-1)">−</button>
          <div class="val" id="p_pv_val">6 / 6</div>
          <button class="btn ghost" onclick="inc('p_pv',1)">+</button>
        </div>
      </div>
      <div class="col">
        <label for="p_ps">PS</label>
        <div class="counter">
          <button class="btn ghost" onclick="inc('p_ps',-1)">−</button>
          <div class="val" id="p_ps_val">6 / 6</div>
          <button class="btn ghost" onclick="inc('p_ps',1)">+</button>
        </div>
      </div>
      <div class="col">
        <label for="p_escudos">ESC</label>
        <div class="counter">
          <button class="btn ghost" onclick="inc('p_escudos',-1)">−</button>
          <div class="val" id="p_escudos_val">0 / 6</div>
          <button class="btn ghost" onclick="inc('p_escudos',1)">+</button>
        </div>
      </div>
      <div class="col" style="flex: none; width: 100%;">
        <label for="p_xp">XP</label>
        <div class="counter">
          <input id="p_xp_input" type="number" value="0" style="width: auto; flex: 1;" onchange="updateXpManually()">
          <button class="btn ghost" onclick="showXpHistoryModal()">Histórico</button>
        </div>
        <div class="row wrap" style="margin-top: 8px;">
          <button class="btn ghost" onclick="showXpModal(1)">+1</button>
          <button class="btn ghost" onclick="showXpModal(2)">+2</button>
          <button class="btn ghost" onclick="showXpModal(5)">+5</button>
          <button class="btn ghost" onclick="showXpModal(10)">+10</button>
          <button class="btn ghost" onclick="showXpModal(50)">+50</button>
        </div>
      </div>
    </div>
  </section>

  <!-- TESTES GENÉRICOS -->
  <section class="card" id="sec-testes">
    <h3 style="margin:0 0 8px 0;">🎲 Testes Genéricos</h3>
    <div class="row wrap" id="generic-test-buttons">
      <!-- Botões de teste genérico serão renderizados aqui -->
    </div>
    <div class="sep"></div>
    <div class="actions">
      <button class="btn ghost" onclick="rolarDadosLivres(4)">D4</button>
      <button class="btn ghost" onclick="rolarDadosLivres(6)">D6</button>
      <button class="btn ghost" onclick="rolarDadosLivres(8)">D8</button>
      <button class="btn ghost" onclick="rolarDadosLivres(10)">D10</button>
      <button class="btn ghost" onclick="rolarDadosLivres(12)">D12</button>
      <button class="btn ghost" onclick="rolarDadosLivres(20)">D20</button>
    </div>
    <div id="area-rolagem"></div>
  </section>

  <!-- ÁRVORES DE HABILIDADE -->
  <section class="card">
    <div class="row" style="justify-content: space-between;">
      <h3 style="margin:0;">🌳 Árvores de Habilidade</h3>
      <div class="actions">
        <button class="btn ghost" onclick="showAllCaracteristicasModal()">📖 Ver Características</button>
        <button class="btn" onclick="addArvore()">➕ Adicionar Árvore</button>
        <button class="btn ghost" onclick="showManualModal()">⚙️ Ferramentas Manuais</button>
      </div>
    </div>
    <div class="list" id="lista-arvores"></div>
  </section>

  <!-- INVENTÁRIO -->
  <section class="card" id="sec-inventario">
    <h3 style="margin:0 0 8px 0;">🎒 Inventário</h3>
    <div style="margin-bottom: 16px;">
        <h4 style="margin: 0 0 8px 0;">Comprar na Loja de XP</h4>
        <div class="row wrap">
            <div class="col" style="min-width: 100px;">
                <label for="i_cat_std">Categoria</label>
                <select id="i_cat_std" onchange="updateItemCost()"></select>
            </div>
            <div class="col" style="min-width: 100px;">
                <label for="i_lvl_std">Nível</label>
                <select id="i_lvl_std" onchange="updateItemCost()">
                    <option value="1">Nível 1</option>
                    <option value="2">Nível 2</option>
                    <option value="3">Nível 3</option>
                    <option value="4">Nível 4</option>
                    <option value="5">Nível 5</option>
                    <option value="6">Nível 6</option>
                </select>
            </div>
            <div class="col" style="min-width: 100px;">
                <label>Custo (XP)</label>
                <div class="val" id="i_cost_val">20</div>
            </div>
        </div>
        <div class="actions" style="margin-top: 8px;">
            <button class="btn" onclick="addStandardItem()">➕ Comprar Item</button>
        </div>
    </div>
    <div class="sep"></div>
    <div style="margin-bottom: 16px;">
        <h4 style="margin: 0 0 8px 0;">Adicionar Item Personalizado</h4>
        <div class="actions" style="margin-bottom: 10px;">
            <div class="row">
                <label class="slider-text" for="loot-toggle" style="line-height: 20px;">Loot</label>
                <label class="switch">
                    <input type="checkbox" id="loot-toggle" onchange="updateCustomItemCost()">
                    <span class="slider"></span>
                </label>
                <label class="slider-text" for="loot-toggle" style="line-height: 20px; right: 0;">Comprar</label>
            </div>
        </div>
        <div class="grid2">
            <div>
                <label for="i_nome_custom">Nome</label>
                <input id="i_nome_custom" placeholder="Ex.: Espada Rúnica" />
            </div>
            <div>
                <label for="i_cat_custom">Categoria</label>
                <select id="i_cat_custom" onchange="updateCustomItemStats()"></select>
            </div>
            <div>
                <label for="i_lvl_custom">Nível</label>
                <select id="i_lvl_custom" onchange="updateCustomItemStats()">
                    <option value="1">Nível 1</option>
                    <option value="2">Nível 2</option>
                    <option value="3">Nível 3</option>
                    <option value="4">Nível 4</option>
                    <option value="5">Nível 5</option>
                    <option value="6">Nível 6</option>
                </select>
            </div>
            <div class="col" style="min-width: 100px;">
                <label>Usos</label>
                <div class="val" id="i_usos_custom">6</div>
            </div>
        </div>
        <div class="grid2" style="margin-top: 10px;">
            <div class="col" style="min-width: 100px;">
                <label>Bônus (+xD6)</label>
                <div class="val" id="i_bonus_custom">1</div>
            </div>
            <div class="col" style="min-width: 100px;">
                <label>XP (custo)</label>
                <div class="val" id="i_xp_custom">20</div>
            </div>
        </div>
        <label for="i_fx_custom" style="margin-top:8px;">Efeito (texto livre)</label>
        <textarea id="i_fx_custom" placeholder="Ex.: +2D6 ao atacar. Quando a lâmina brilha, recupera 1 PV por 6 rolado."></textarea>
        <label for="arvore_vinculada_custom" style="margin-top: 8px;">Vincular a Árvore</label>
        <select id="arvore_vinculada_custom"></select>
        <div class="actions" style="margin-top:8px;">
            <button class="btn" onclick="addCustomItem()">➕ Adicionar Item</button>
            <button class="btn ghost" onclick="quickAddSample()">⚡ Exemplo</button>
        </div>
    </div>
    <div class="sep"></div>
    <div class="list" id="lista-itens"></div>
  </section>
  
  <!-- GERAÇÃO DE CONTEÚDO COM IA -->
  <section class="card" id="sec-gemini">
      <h3 style="margin:0 0 8px 0;">✨ Geração de Conteúdo com IA</h3>
      <div class="col">
          <label for="gemini_prompt">Descreva o que deseja gerar:</label>
          <textarea id="gemini_prompt" placeholder="Ex: Crie uma história de origem para um cavaleiro que perdeu sua memória e agora busca redenção."></textarea>
      </div>
      <div class="actions" style="margin-top: 8px;">
          <button class="btn ok" onclick="generateContentWithGemini()">Gerar Conteúdo</button>
          <div id="gemini-loading" style="display: none; padding: 10px; color: var(--muted);">
              Gerando...
          </div>
      </div>
  </section>

  <!-- NOTAS -->
  <section class="card">
    <label for="p_conceito">Conceito e História</label>
    <textarea id="p_conceito" placeholder="Ex.: Cavaleiro honrado em busca de redenção..." onchange="updateCharacterDetails()"></textarea>
    <label for="p_notas" style="margin-top:8px;">Notas Adicionais</label>
    <textarea id="p_notas" placeholder="Anotações rápidas..." onchange="updateCharacterDetails()"></textarea>
  </section>

  <!-- EXPORT / IMPORT / RESET -->
  <section class="card">
    <div class="actions">
      <button class="btn ok" onclick="exportar()">⬇️ Exportar JSON</button>
      <label class="btn ghost" for="imp" style="cursor:pointer;">⬆️ Importar JSON</label>
      <input id="imp" type="file" accept="application/json" style="display:none" onchange="importar(event)" />
      <button class="btn danger right" onclick="resetar()">🗑️ Resetar Ficha</button>
    </div>
    <div class="muted small">Dados ficam apenas no seu dispositivo (LocalStorage).</div>
    <div class="actions" style="margin-top: 12px;">
      <button class="btn ok" onclick="gerarPdfFicha()">Gerar PDF da Ficha</button>
    </div>
  </section>

</main>

<!-- PDF version (hidden from view) -->
<div id="printable-content" style="display: none;">
  <div style="display: flex; flex-direction: column; padding: 20px; font-family: sans-serif; color: #000; height: 100%;">
    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
      <div style="flex: 0 0 100px; height: 100px; border: 1px solid #000; overflow: hidden; position: relative;">
        <img id="print-foto-img" style="width: 100px; height: 100px; position: absolute; transform-origin: 0 0;">
      </div>
      <div style="flex: 1;">
        <h2 style="margin: 0; font-size: 24px;">Ficha de Personagem</h2>
        <p style="margin: 0; font-size: 14px;">Nome: <span id="print-nome"></span></p>
        <p style="margin: 0; font-size: 14px;">Raça: <span id="print-raca"></span></p>
        <p style="margin: 0; font-size: 14px;">Classe: <span id="print-classe"></span></p>
      </div>
    </div>
    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
      <div style="flex: 1;">
        <h3 style="border-bottom: 1px solid #000; margin: 0 0 10px 0; font-size: 18px;">Atributos</h3>
        <p style="margin: 0;">Nível: <span id="print-nivel"></span></p>
        <p style="margin: 0;">XP: <span id="print-xp"></span></p>
        <p style="margin: 0;">PV: <span id="print-pv"></span></p>
        <p style="margin: 0;">PS: <span id="print-ps"></span></p>
        <p style="margin: 0;">ESC: <span id="print-escudos"></span></p>
      </div>
    </div>
    <div style="flex: 1;">
        <h3 style="border-bottom: 1px solid #000; margin: 0 0 10px 0; font-size: 18px;">Árvores de Habilidade</h3>
        <div id="print-arvores-list"></div>
    </div>
    <div style="flex: 1;">
        <h3 style="border-bottom: 1px solid #000; margin: 0 0 10px 0; font-size: 18px;">Inventário</h3>
        <div id="print-itens-list"></div>
    </div>
    <div style="flex: 1;">
      <h3 style="border-bottom: 1px solid #000; margin: 0 0 10px 0; font-size: 18px;">Notas</h3>
      <p style="margin: 0; white-space: pre-wrap;" id="print-notas"></p>
    </div>
  </div>
</div>

<script>
  // ======== ESTADO E ARMAZENAMENTO ========
  const STATE_KEY = "alpha_ficha_v2";
  let S = {
    personagem: {
      nome: "", raca: "", classe: "", conceito: "", notas: "",
      nivel: 1, xp: 0,
      pv_atual: 6, pv_max: 6,
      ps_atual: 6, ps_max: 6,
      xpHistory: [],
      escudos: 0,
      fotoUrl: '',
      imageTransform: { scale: 1, x: 0, y: 0 }
    },
    arvores: [],
    inventario: [],
    modificadoresTemporarios: {},
    categoriasPersonalizadas: {}
  };

  const CATEGORIAS_PADRAO = ["Ataque", "Defesa", "Suporte"];
  const CARACTERISTICAS = {
    "Ataque": [
      { nome: "Perfurante", descricao: "1 de dano garantido, ignorando a defesa do alvo." },
      { nome: "Sangramento", descricao: "Causa 1 de dano por turno ao alvo." },
      { nome: "Dreno Vital", descricao: "Recupera PV igual aos 6s obtidos na rolagem de ataque." },
      { nome: "Empurrão", descricao: "Empurra o alvo 3 metros." }
    ],
    "Defesa": [
      { nome: "Escudo", descricao: "Ao obter um sucesso na rolagem de defesa, você ganha escudos temporários igual ao número de 6s rolados." },
      { nome: "Refletir", descricao: "Reflete 1 de dano para cada 6 obtido na rolagem de defesa." },
      { nome: "Proteção de Aliado", descricao: "Permite interceptar um ataque direcionado a um aliado próximo." },
      { nome: "Contra-ataque", descricao: "Se a defesa for bem-sucedida, o personagem pode fazer um ataque imediato como uma reação." }
    ],
    "Suporte": [
      { nome: "Duração Estendida", descricao: "O efeito da habilidade dura o dobro do tempo." },
      { nome: "Efeito em Área", descricao: "Afeta múltiplos alvos." },
      { nome: "Purificar", descricao: "Remove uma condição negativa." },
      { nome: "Análise Tática", descricao: "Revela uma fraqueza no alvo, permitindo que um aliado ou você mesmo receba +1 dado na próxima rolagem de ataque contra ele." }
    ],
  };

  // Tabela de Itens para compra automática
  const ITEM_TABLE = {
    "1": { uses: 6, xp: 20, bonus: 1, fx: "+1D6 no próximo ataque corpo a corpo." },
    "2": { uses: 5, xp: 40, bonus: 2, fx: "+2D6 no ataque. Cada 6 também aplica Lento (o alvo perde a Reação até o próximo turno)." },
    "3": { uses: 4, xp: 80, bonus: 3, fx: "+3D6 no ataque. Cada '6' também aplica Queimando (1 de dano por turno por 2 turnos)." },
    "4": { uses: 3, xp: 160, bonus: 4, fx: "+4D6. Cada 6 aplica Queimando (1 de dano por 3 turnos) e ignora resistência a fogo." },
    "5": { uses: 2, xp: 320, bonus: 5, fx: "+5D6 no ataque. Cada 6 aplica Queimando (1 de dano por 3 turnos) e ignora resistência a fogo. Se houver 3 ou mais 6, explode causando 2 de dano a todos num raio de 2 metros (incluindo aliados)." },
    "6": { uses: 1, bonus: 6, xp: 640, fx: "+6D6. Cada 6 aplica Queimando e Cegueira. Se houver 3 ou mais 6s, causa uma explosão em área." },
  };

  let ultimaRolagem = null;
  let habilidadeParaCaracteristica = null;
  let xpToAdd = 0;
  let editingItemId = null;
  
  const L = id => document.getElementById(id);
  
  let scale = 1;
  let offsetX = 0;
  let offsetY = 0;
  let isDragging = false;
  let moveInterval = null;
  let zoomInterval = null;

  const imageToCropEl = document.getElementById('image-to-crop');
  const cropperContainer = document.getElementById('image-cropper-container');


  function showAlertMessage(title, text) {
    const modal = document.getElementById("alert-modal");
    document.getElementById("alert-title").innerText = title;
    document.getElementById("alert-text").innerText = text;
    modal.style.display = "flex";
  }

  function hideAlertMessage() {
    document.getElementById("alert-modal").style.display = "none";
  }
  
  function showXpModal(amount) {
    xpToAdd = amount;
    document.getElementById('xp-value').innerText = amount;
    document.getElementById('xp-other-reason').value = "";
    document.getElementById('xp-modal').style.display = "flex";
  }

  function hideXpModal() {
    document.getElementById('xp-modal').style.display = "none";
  }
  
  function addXpWithReason(reason) {
      if (!reason.trim()) {
          showAlertMessage("Erro", "Por favor, especifique o motivo para o XP.");
          return;
      }
      S.personagem.xp += xpToAdd;
      S.personagem.xpHistory.push({ amount: xpToAdd, reason: reason, date: new Date().toISOString() });
      showAlertMessage("XP Adicionado", `${xpToAdd} XP adicionados por: ${reason}`);
      save();
      hideXpModal();
  }

  function showXpHistoryModal() {
      const modal = document.getElementById("xp-history-modal");
      const list = document.getElementById("xp-history-list");
      list.innerHTML = "";
      
      const sortedHistory = S.personagem.xpHistory.sort((a, b) => new Date(b.date) - new Date(a.date));

      if (sortedHistory.length > 0) {
          sortedHistory.forEach(entry => {
              const div = document.createElement("div");
              div.className = "item";
              const date = new Date(entry.date).toLocaleString('pt-BR');
              const type = entry.amount > 0 ? `<span class="tag ok">Ganho</span>` : `<span class="tag bad">Gasto</span>`;
              div.innerHTML = `
                  <h4>${entry.reason} ${type}</h4>
                  <div class="muted">${entry.amount} XP • ${date}</div>
              `;
              list.appendChild(div);
          });
      } else {
          list.innerHTML = '<p class="muted" style="text-align: center;">Nenhum registro de XP encontrado.</p>';
      }

      modal.style.display = "flex";
  }
  
  function hideXpHistoryModal() {
      document.getElementById('xp-history-modal').style.display = "none";
  }
  
  function updateXpManually() {
      const newXp = parseInt(document.getElementById('p_xp_input').value) || 0;
      const oldXp = S.personagem.xp;
      const diff = newXp - oldXp;
      
      if (diff === 0) return;

      const reason = diff > 0 ? `Ajuste manual de XP (Adicionado)` : `Ajuste manual de XP (Removido)`;
      S.personagem.xp = newXp;
      S.personagem.xpHistory.push({ amount: diff, reason: reason, date: new Date().toISOString() });
      save();
  }

  function save() {
    localStorage.setItem(STATE_KEY, JSON.stringify(S));
    render();
  }

  function load() {
    const raw = localStorage.getItem(STATE_KEY);
    if (raw) {
      try {
        const loadedState = JSON.parse(raw);
        if (!loadedState.arvores) loadedState.arvores = [];
        if (!loadedState.modificadoresTemporarios) loadedState.modificadoresTemporarios = {};
        if (!loadedState.categoriasPersonalizadas) loadedState.categoriasPersonalizadas = {};
        if (!loadedState.personagem.xpHistory) loadedState.personagem.xpHistory = [];
        S = loadedState;
        S.arvores.forEach(arvore => {
            arvore.habilidades.forEach(h => {
                if (!Array.isArray(h.caracteristicas)) {
                    h.caracteristicas = h.caracteristicas ? Object.values(h.caracteristicas) : [];
                }
            });
        });
      } catch (e) {
        console.error("Erro ao carregar estado do localStorage:", e);
      }
    }
    S.personagem.ps_max = 6;
    S.personagem.pv_max = 6 + (S.personagem.nivel - 1) * 2;
    S.personagem.ps_atual = Math.min(S.personagem.ps_atual, S.personagem.ps_max);
    S.personagem.pv_atual = Math.min(S.personagem.pv_atual, S.personagem.pv_max);
    if (!S.personagem.escudos) S.personagem.escudos = 0;
    if (!S.personagem.imageTransform) S.personagem.imageTransform = { scale: 1, x: 0, y: 0 };
    render();
  }

  function updateCharacterDetails() {
    S.personagem.nome = document.getElementById("p_nome").value || "";
    S.personagem.raca = document.getElementById("p_raca").value || "";
    S.personagem.classe = document.getElementById("p_classe").value || "";
    S.personagem.conceito = document.getElementById("p_conceito").value || "";
    S.personagem.notas = document.getElementById("p_notas").value || "";
    save();
  }
  
  function updateCharacterLevel() {
      S.personagem.nivel = parseInt(document.getElementById('p_nivel').value);
      S.personagem.pv_max = 6 + (S.personagem.nivel - 1) * 2;
      S.personagem.pv_atual = Math.min(S.personagem.pv_atual, S.personagem.pv_max);
      save();
  }

  // ======== BIND UI & RENDERIZAÇÃO ========
  function render() {
    document.getElementById("p_nome").value = S.personagem.nome || "";
    document.getElementById("p_raca").value = S.personagem.raca || "";
    document.getElementById("p_classe").value = S.personagem.classe || "";
    document.getElementById("p_conceito").value = S.personagem.conceito || "";
    document.getElementById("p_notas").value = S.personagem.notas || "";
    document.getElementById("p_nivel").value = S.personagem.nivel;
    document.getElementById("p_xp_input").value = S.personagem.xp;
    document.getElementById("p_pv_val").innerText = `${S.personagem.pv_atual} / ${S.personagem.pv_max}`;
    document.getElementById("p_ps_val").innerText = `${S.personagem.ps_atual} / ${S.personagem.ps_max}`;
    document.getElementById("p_escudos_val").innerText = `${S.personagem.escudos} / ${S.personagem.pv_max}`;
    
    const imgEl = document.getElementById('p_foto_img');
    const transform = S.personagem.imageTransform;
    imgEl.src = S.personagem.fotoUrl || "https://placehold.co/100x100";
    imgEl.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
    imgEl.style.objectFit = 'cover';
    
    if (S.personagem.fotoUrl) {
        document.getElementById('btn-edit-photo').style.display = 'block';
    } else {
        document.getElementById('btn-edit-photo').style.display = 'none';
    }
    renderGenericTestButtons();
    renderArvoreSelection();
    renderArvores();
    renderItens();
  }
  
  document.getElementById('p_foto_upload').addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('image-to-crop').src = e.target.result;
        document.getElementById('image-cropper-modal').style.display = 'flex';
        scale = 1;
        offsetX = 0;
        offsetY = 0;
        document.getElementById('image-to-crop').style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
      };
      reader.readAsDataURL(file);
    }
  });
  
  function editProfilePic() {
      if (S.personagem.fotoUrl) {
          document.getElementById('image-to-crop').src = S.personagem.fotoUrl;
          document.getElementById('image-cropper-modal').style.display = 'flex';
          const transform = S.personagem.imageTransform;
          document.getElementById('image-to-crop').style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
          scale = transform.scale;
          offsetX = transform.x;
          offsetY = transform.y;
      } else {
          showAlertMessage("Erro", "Nenhuma imagem de perfil para editar. Por favor, faça o upload de uma imagem primeiro.");
      }
  }


  if (imageToCropEl && cropperContainer) {
      const imageEl = imageToCropEl;
      
      let initialX, initialY;
      
      const startDrag = (e) => {
          e.preventDefault();
          isDragging = true;
          imageEl.classList.add('is-dragging');
          
          if (e.touches) {
              initialX = e.touches[0].clientX - offsetX;
              initialY = e.touches[0].clientY - offsetY;
          } else {
              initialX = e.clientX - offsetX;
              initialY = e.clientY - offsetY;
          }
      };

      const doDrag = (e) => {
          if (isDragging) {
              let clientX, clientY;
              if (e.touches) {
                  clientX = e.touches[0].clientX;
                  clientY = e.touches[0].clientY;
              } else {
                  clientX = e.clientX;
                  clientY = e.clientY;
              }
              offsetX = clientX - initialX;
              offsetY = clientY - initialY;
              imageEl.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
          }
      };

      const endDrag = () => {
          isDragging = false;
          imageEl.classList.remove('is-dragging');
      };
      
      imageEl.addEventListener('mousedown', startDrag);
      imageEl.addEventListener('touchstart', startDrag);
      
      document.addEventListener('mousemove', doDrag);
      document.addEventListener('touchmove', doDrag);

      document.addEventListener('mouseup', endDrag);
      document.addEventListener('touchend', endDrag);
      
      imageEl.addEventListener('mouseleave', endDrag);
  }
  
  function startZoom(delta) {
      if(zoomInterval) clearInterval(zoomInterval);
      zoomInterval = setInterval(() => {
          scale = Math.max(0.1, scale + delta);
          document.getElementById('image-to-crop').style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
      }, 50);
  }

  function startMove(dx, dy) {
      if(moveInterval) clearInterval(moveInterval);
      moveInterval = setInterval(() => {
          offsetX += dx;
          offsetY += dy;
          document.getElementById('image-to-crop').style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
      }, 50);
  }

  function stopMove() {
      if(moveInterval) clearInterval(moveInterval);
      if(zoomInterval) clearInterval(zoomInterval);
  }

  function cropAndSaveImage() {
    const imgEl = document.getElementById('p_foto_img');
    const transform = {
      x: offsetX,
      y: offsetY,
      scale: scale
    };
    S.personagem.fotoUrl = document.getElementById('image-to-crop').src;
    S.personagem.imageTransform = transform;
    save();
    cancelCrop();
  }

  function cancelCrop() {
    document.getElementById('image-cropper-modal').style.display = 'none';
    scale = S.personagem.imageTransform.scale;
    offsetX = S.personagem.imageTransform.x;
    offsetY = S.personagem.imageTransform.y;
    document.getElementById('image-to-crop').style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
  }


  function inc(kind, delta) {
    if (kind === "p_pv") {
      S.personagem.pv_atual = Math.max(0, Math.min(S.personagem.pv_max, S.personagem.pv_atual + delta));
    } else if (kind === "p_ps") {
      S.personagem.ps_atual = Math.max(0, Math.min(S.personagem.ps_max, S.personagem.ps_atual + delta));
    } else if (kind === "p_escudos") {
      S.personagem.escudos = Math.max(0, Math.min(S.personagem.pv_max, S.personagem.escudos + delta));
    }
    save();
  }

  // ======== REGRAS DE ROLAGEM (D6) ========
  function avaliar(resultados, nDados, nivelHabilidade) {
    const c6 = resultados.filter(v => v === 6).length;
    const c1 = resultados.filter(v => v === 1).length;
    let tipo = "Falha";
    const metade = Math.ceil(nDados / 2);

    if (c6 >= 1) {
        tipo = "Sucesso";
    }
    if (nivelHabilidade >= 3 && c6 >= metade) {
        tipo = "Sucesso Crítico";
    }

    if (nivelHabilidade >= 3 && c1 >= metade && c6 === 0) {
        tipo = "Falha Crítica";
    } else if (c6 === 0) {
        tipo = "Falha";
    }
    
    return { n: nDados, c6, c1, tipo };
  }

  function rolarND6(n) {
    n = Math.max(1, Math.floor(n));
    const out = [];
    for (let i = 0; i < n; i++) out.push(1 + Math.floor(Math.random() * 6));
    return out;
  }

  function clearAllRollResults() {
    const mainResultArea = document.getElementById('area-rolagem');
    if (mainResultArea) mainResultArea.innerHTML = '';
    
    document.querySelectorAll('[id^="hab-result-"]').forEach(el => el.innerHTML = '');
    document.querySelectorAll('[id^="item-result-"]').forEach(el => el.innerHTML = '');
  }

  // ======== UI DE ROLAGEM (dados clicáveis + ações PS) ========
  function desenharRolagem(containerId, rollData, isItemRolagem = false, arvoreId = null, habId = null, itemId = null) {
    const cont = document.getElementById(containerId);
    if (!cont) return;

    cont.innerHTML = '';

    if (!rollData) return;

    const diceArea = document.createElement("div");
    diceArea.className = "dice-area";
    rollData.resultados.forEach((v, idx) => {
      const d = document.createElement("div");
      d.className = "die" + (v === 6 ? " six" : "") + (v === 1 ? " one" : "");
      d.innerText = v;
      d.title = "Toque para rerrolar este dado (custa 1 PS)";
      d.onclick = () => rerrolarUmDado(idx, isItemRolagem, containerId, arvoreId, habId, itemId);
      diceArea.appendChild(d);
    });
    cont.appendChild(diceArea);

    const r = avaliar(rollData.resultados, rollData.meta.nRolados, rollData.meta.nivelHabilidade);
    const res = document.createElement("div");
    res.className = "result";
    let subInfo = "";
    if (rollData.meta.origem.includes("Item:")) {
      subInfo = `(Habilidade de Nível ${rollData.meta.nBase} + Bônus de Item +${rollData.meta.bonusItem}D6)`;
    } else if (rollData.meta.origem.includes("Teste Genérico")) {
      subInfo = `(Nível da Árvore mais alta de ${rollData.meta.origem.split("de ")[1]})`;
    } else {
       subInfo = `(Nível da Habilidade: ${rollData.meta.nivelHabilidade}D6)`;
    }
    
    let resultadoTexto = "";
    if (r.tipo === "Sucesso Crítico") {
      resultadoTexto = "Sucesso Crítico! Ação bem-sucedida com um bônus narrativo.";
    } else if (r.tipo === "Sucesso") {
      resultadoTexto = "Sucesso! Ação bem-sucedida.";
    } else if (r.tipo === "Falha") {
      resultadoTexto = "Falha! A ação não foi bem-sucedida.";
    } else if (r.tipo === "Falha Crítica") {
      resultadoTexto = "Falha Crítica! A ação falhou com uma consequência negativa significativa.";
    }

    res.innerHTML = `
      <h3>${resultadoTexto}</h3>
      <div class="muted small">${subInfo}</div>
      <div class="muted">6s: ${r.c6} | 1s: ${r.c1} | Dados: ${r.n}</div>
    `;
    cont.appendChild(res);

    const act = document.createElement("div");
    act.className = "actions";
    if (S.personagem.ps_atual > 0) {
      if ((r.tipo === "Falha" || r.tipo === "Falha Crítica")) {
        const b = document.createElement("button");
        b.className = "btn warn";
        b.innerText = "Gastar 1 PS: Elevar para Sucesso";
        b.onclick = () => { if (gastarPS()) {
          const falhaIndex = rollData.resultados.findIndex(d => d !== 6);
          if (falhaIndex !== -1) { rollData.resultados[falhaIndex] = 6; }
          // FIX: Call the new draw function with the roll data
          desenharRolagem(containerId, rollData, isItemRolagem, arvoreId, habId, itemId);
        } };
        act.appendChild(b);
      }
      if (r.tipo === "Sucesso") {
        const b = document.createElement("button");
        b.className = "btn ok";
        b.innerText = "Gastar 1 PS: Elevar a Sucesso Crítico";
        b.onclick = () => { if (gastarPS()) {
          const sucessoIndex = rollData.resultados.findIndex(d => d !== 6);
          if (sucessoIndex !== -1) { rollData.resultados[sucessoIndex] = 6; }
          // FIX: Call the new draw function with the roll data
          desenharRolagem(containerId, rollData, isItemRolagem, arvoreId, habId, itemId);
        } };
        act.appendChild(b);
      }
    }
    cont.appendChild(act);
    
    const efeitos = [];
    const arvore = S.arvores.find(a => a.id === arvoreId);
    const habilidade = findHabilidade(arvoreId, habId);
    const displayCategory = arvore ? (arvore.categoria === "Adicional" ? arvore.nomeCategoriaCustomizada : arvore.categoria) : null;
    
    if ((r.tipo === "Sucesso" || r.tipo === "Sucesso Crítico")) {
      if (habilidade && habilidade.nivel < 6) {
          const proximoNivel = habilidade.nivel + 1;
          if (!arvore.habilidades.some(h => h.nivel === proximoNivel)) {
            arvore.habilidades.push({ id: crypto.randomUUID(), nivel: proximoNivel, nome: "", caracteristicas: [] });
            arvore.habilidades.sort((a, b) => a.nivel - b.nivel);
            efeitos.push(`• Evolução Natural: Você liberou a habilidade de Nível ${proximoNivel}.`);
            save();
          }
        }
      S.arvores.forEach(arvore => {
        if (arvore.habilidades.some(h => h.nivel === 6) && !arvore.nivelUpDado) {
          arvore.nivelUpDado = true;
          S.personagem.nivel++;
          S.personagem.pv_max = 6 + (S.personagem.nivel - 1) * 2;
          S.personagem.ps_max = Math.min(6, S.personagem.ps_max + 1);
          efeitos.push(`• Nível de Personagem: Você subiu para o Nível ${S.personagem.nivel}!`);
          save();
        }
      });
    }

    if (r.tipo === "Sucesso Crítico" && habilidade && habilidade.nivel >= 3 && habilidade.caracteristicas.length < 3) {
        habilidadeParaCaracteristica = { arvoreId: arvoreId, habId: habId, categoria: arvore.categoria, nomeCategoriaCustomizada: arvore.nomeCategoriaCustomizada };
        renderCaracteristicaModal();
    }
    
    if (r.tipo === "Sucesso Crítico" && r.c6 === rollData.meta.nRolados && S.personagem.nivel >= 3) {
      if (!rollData._bonusPS) {
          S.personagem.ps_atual = Math.min(S.personagem.ps_atual + 1, S.personagem.ps_max);
          efeitos.push("• Sucesso Perfeito: Você recupera 1 Ponto de Sorte.");
          rollData._bonusPS = true;
          save();
        }
      }
    
    if (habilidade) {
        const perfs = habilidade.caracteristicas.filter(c => c === "Perfurante").length;
        if (perfs > 0 && displayCategory === "Ataque") {
            efeitos.push(`• Perfurante: Causa +${perfs} de dano garantido.`);
        }
        const sngs = habilidade.caracteristicas.filter(c => c === "Sangramento").length;
        if (sngs > 0 && displayCategory === "Ataque") {
            efeitos.push(`• Sangramento: O alvo sofre ${sngs} de dano por turno.`);
        }
        const drns = habilidade.caracteristicas.filter(c => c === "Dreno Vital").length;
        if (drns > 0 && displayCategory === "Ataque") {
            const pvRecuperados = drns * r.c6;
            if (pvRecuperados > 0) {
                S.personagem.pv_atual = Math.min(S.personagem.pv_max, S.personagem.pv_atual + pvRecuperados);
                efeitos.push(`• Dreno Vital: Recuperou ${pvRecuperados} PV.`);
            }
        }
        const emps = habilidade.caracteristicas.filter(c => c === "Empurrão").length;
        if (emps > 0 && displayCategory === "Ataque") {
            const metros = emps * 3;
            if (metros > 0) efeitos.push(`• Empurrão: O alvo é empurrado ${metros} metros.`);
        }
        const escs = habilidade.caracteristicas.filter(c => c === "Escudo").length;
        if (escs > 0 && displayCategory === "Defesa" && (r.tipo === "Sucesso" || r.tipo === "Sucesso Crítico")) {
            const escudosGanhos = escs * r.c6;
            if (escudosGanhos > 0) {
                S.personagem.escudos = Math.min(S.personagem.pv_max, S.personagem.escudos + escudosGanhos);
                efeitos.push(`• Escudo: Você ganhou ${escudosGanhos} de escudo!`);
            }
        }
        const refs = habilidade.caracteristicas.filter(c => c === "Refletir").length;
        if (refs > 0 && displayCategory === "Defesa" && (r.tipo === "Sucesso" || r.tipo === "Sucesso Crítico")) {
            const danoRefletido = refs * r.c6;
            if (danoRefletido > 0) efeitos.push(`• Refletir: Reflete ${danoRefletido} de dano para o atacante!`);
        }
        const pads = habilidade.caracteristicas.filter(c => c === "Proteção de Aliado").length;
        if (pads > 0 && displayCategory === "Defesa") {
            if (pads > 0) efeitos.push(`• Proteção de Aliado: Permite interceptar um ataque direcionado a ${pads} aliado(s) próximo(s).`);
        }
        const cnts = habilidade.caracteristicas.filter(c => c === "Contra-ataque").length;
        if (cnts > 0 && displayCategory === "Defesa" && (r.tipo === "Sucesso" || r.tipo === "Sucesso Crítico")) {
              if (cnts > 0) efeitos.push(`• Contra-ataque: Sua defesa foi bem-sucedida. Você pode fazer um ataque imediato como uma reação.`);
        }
        const dures = habilidade.caracteristicas.filter(c => c === "Duração Estendida").length;
        if (dures > 0 && displayCategory === "Suporte") {
            const duracao = dures * 2;
            if (duracao > 0) efeitos.push(`• Duração Estendida: O efeito da habilidade dura o dobro do tempo.`);
        }
        const eareas = habilidade.caracteristicas.filter(c => c === "Efeito em Área").length;
        if (eareas > 0 && displayCategory === "Suporte") {
            if (eareas > 0) efeitos.push(`• Efeito em Área: Afeta ${eareas} alvos adicionais.`);
        }
        const purs = habilidade.caracteristicas.filter(c => c === "Purificar").length;
        if (purs > 0 && displayCategory === "Suporte") {
            if (purs > 0) efeitos.push(`• Purificar: Remove ${purs} condição(ões) negativa(s).`);
        }
        const anals = habilidade.caracteristicas.filter(c => c === "Análise Tática").length;
        if (anals > 0 && displayCategory === "Suporte") {
            const bonus = anals;
            if (bonus > 0) S.modificadoresTemporarios.proximoAtaqueBonus = bonus;
            if (bonus > 0) efeitos.push(`• Análise Tática: Aliado ou você ganha +${bonus} dado(s) na próxima rolagem de ataque contra o alvo.`);
        }
    }
    
    if (isItemRolagem && itemId) {
        const item = S.inventario.find(i => i.id === itemId);
        if (item && r.tipo === 'Falha Crítica' && item.estado === 'Danificado') {
            item.estado = 'Quebrado';
            efeitos.push(`• Quebra: O item '${item.name}' se quebrou devido à Falha Crítica.`);
            save();
        }
        
        if (item && item.arvoreVinculada && (r.tipo === "Sucesso" || r.tipo === "Sucesso Crítico")) {
            const arvore = S.arvores.find(a => a.id === item.arvoreVinculada);
            const nivelArvore = arvore.habilidades.length;
            if (nivelArvore < 6) {
                const proximoNivel = nivelArvore + 1;
                arvore.habilidades.push({ id: crypto.randomUUID(), nivel: proximoNivel, nome: "", caracteristicas: [] });
                arvore.habilidades.sort((a, b) => a.nivel - b.nivel);
                efeitos.push(`• Evolução de Item: A árvore de habilidade vinculada, "${arvore.nome}", subiu para o Nível ${proximoNivel}.`);
                save();
            }
        }
    }

    if (efeitos.length > 0) {
        const efeitoTexto = "Rolagem concluída! Efeitos ativados:\n\n" + efeitos.join("\n");
        showAlertMessage("Rolagem Concluída", efeitoTexto);
        save();
    }
  }

  function gastarPS() {
    if (S.personagem.ps_atual <= 0) {
      showAlertMessage("Sem PS", "Você não tem Pontos de Sorte suficientes.");
      return false;
    }
    S.personagem.ps_atual--;
    save();
    return true;
  }

  function rerrolarUmDado(idx, isItemRolagem = false, containerId = 'area-rolagem', arvoreId = null, habId = null, itemId = null) {
    if (!gastarPS()) return;
    let rollData = null;
    if(isItemRolagem) {
      const item = S.inventario.find(i => i.id === itemId);
      if (item) rollData = item.lastRoll;
    } else {
      const habilidade = S.arvores.find(a => a.id === arvoreId).habilidades.find(h => h.id === habId);
      if (habilidade) rollData = habilidade.lastRoll;
    }
    if (!rollData) return;
    
    rollData.resultados[idx] = 1 + Math.floor(Math.random() * 6);
    save();
  }
  
  function getCategories() {
      let categories = [...CATEGORIAS_PADRAO];
      const customCategories = S.arvores.filter(a => a.categoria === "Adicional" && a.nomeCategoriaCustomizada).map(a => a.nomeCategoriaCustomizada);
      categories = [...new Set([...categories, ...customCategories])];
      return categories;
  }

  function renderGenericTestButtons() {
    const container = document.getElementById('generic-test-buttons');
    container.innerHTML = "";
    const categories = getCategories();
    categories.forEach(category => {
      if (category === "Adicional" && Object.keys(S.categoriasPersonalizadas).length === 0) {
          return;
      }
      const button = document.createElement('button');
      button.className = 'btn';
      button.innerText = `Testar ${category}`;
      button.onclick = () => rolarTesteGenerico(category);
      container.appendChild(button);
    });
  }

  function rolarTesteGenerico(categoria) {
    clearAllRollResults();

    let dadosExtras = 0;
    if (categoria === "Defesa" && S.modificadoresTemporarios.proximaDefesaBonus) {
        dadosExtras += S.modificadoresTemporarios.proximaDefesaBonus;
        S.modificadoresTemporarios.proximaDefesaBonus = 0;
    } else if (categoria === "Ataque" && S.modificadoresTemporarios.proximoAtaqueBonus) {
        dadosExtras += S.modificadoresTemporarios.proximaAtaqueBonus;
        S.modificadoresTemporarios.proximaAtaqueBonus = 0;
    }

    const arvoresDaCategoria = S.arvores.filter(a => a.categoria === categoria || a.nomeCategoriaCustomizada === categoria);
    let nivelBase = 1;
    if (arvoresDaCategoria.length > 0) {
      const niveis = arvoresDaCategoria.flatMap(a => a.habilidades.map(h => h.nivel));
      nivelBase = niveis.length > 0 ? Math.max(...niveis) : 1;
    }
    const totalDados = nivelBase + dadosExtras;

    const rollData = {
      resultados: rolarND6(totalDados),
      meta: {
        origem: `Teste Genérico de ${categoria}`,
        nRolados: totalDados,
        categoria: categoria,
        nivelHabilidade: nivelBase
      }
    };
    // Store roll data in a temporary place for rerolls
    S.ultimaRolagemTemporaria = rollData;
    save();
  }
  
  function rolarHabilidade(arvoreId, habId) {
    // Clear all roll results before the new roll
    clearAllRollResults();

    const arvore = S.arvores.find(a => a.id === arvoreId);
    const habilidade = arvore.habilidades.find(h => h.id === habId);
    if (!habilidade || !habilidade.nome) {
      showAlertMessage("Habilidade Sem Nome", "Esta habilidade precisa de um nome para ser usada.");
      return;
    }

    let dadosExtras = 0;
    const displayCategory = arvore.categoria === "Adicional" ? arvore.nomeCategoriaCustomizada : arvore.categoria;
    if (displayCategory === "Defesa" && S.modificadoresTemporarios.proximaDefesaBonus) {
        dadosExtras += S.modificadoresTemporarios.proximaDefesaBonus;
        S.modificadoresTemporarios.proximaDefesaBonus = 0;
    } else if (displayCategory === "Ataque" && S.modificadoresTemporarios.proximaAtaqueBonus) {
        dadosExtras += S.modificadoresTemporarios.proximaAtaqueBonus;
        S.modificadoresTemporarios.proximaAtaqueBonus = 0;
    }
    const totalDados = habilidade.nivel + dadosExtras;

    const rollData = {
      resultados: rolarND6(totalDados),
      meta: {
        origem: `Habilidade: ${habilidade.nome}`,
        nRolados: totalDados,
        categoria: displayCategory,
        arvoreId: arvoreId,
        habilidadeId: habId,
        nivelHabilidade: habilidade.nivel
      }
    };
    
    // Store the roll data in the ability object itself
    habilidade.lastRoll = rollData;
    save();
  }
  
  function rolarHabilidadeComItem(arvoreId, habId, itemId) {
    clearAllRollResults();
    
    const arvore = S.arvores.find(a => a.id === arvoreId);
    const habilidade = arvore.habilidades.find(h => h.id === habId);
    const item = S.inventario.find(i => i.id === itemId);

    if (!habilidade || !habilidade.nome) {
      showAlertMessage("Habilidade Sem Nome", "Esta habilidade precisa de um nome para ser usada.");
      return;
    }

    if (!item || item.uses === 0 || item.estado === 'Quebrado') {
        showAlertMessage("Item Indisponível", "O item não pode ser usado.");
        return;
    }

    const nivelBase = habilidade.nivel;
    const bonusItem = item.bonus;
    const totalDados = nivelBase + bonusItem;

    const rollData = {
      resultados: rolarND6(totalDados),
      meta: {
        origem: `Habilidade: ${habilidade.name} com Item: ${item.name}`,
        nRolados: totalDados,
        nBase: nivelBase,
        bonusItem: bonusItem,
        nivelHabilidade: nivelBase,
        categoria: arvore.categoria === "Adicional" ? arvore.nomeCategoriaCustomizada : arvore.categoria,
        arvoreId: arvoreId,
        habilidadeId: habId,
        itemId: itemId
      }
    };

    habilidade.lastRoll = rollData;
    item.uses--;
    if (item.uses === 0) item.estado = "Danificado";
    save();
  }

  function rolarDadosLivres(lados) {
    clearAllRollResults();
    const val = 1 + Math.floor(Math.random() * lados);
    const cont = document.getElementById("area-rolagem");
    cont.innerHTML = `<div class="result"><h3>Rolou D${lados}: ${val}</h3></div>`;
    S.ultimaRolagemTemporaria = null;
  }
  
  // ======== FUNÇÕES DE ÁRVORE E HABILIDADE ========
  
  function toggleArvore(id) {
    const arvore = S.arvores.find(a => a.id === id);
    if (arvore) {
        arvore.isCollapsed = !arvore.isCollapsed;
        save();
    }
  }

  function showArvoreModal() {
    document.getElementById('arvore-modal').style.display = 'flex';
  }

  function hideArvoreModal() {
    document.getElementById('arvore-modal').style.display = 'none';
  }
  
  function addArvore() {
      showArvoreModal();
  }

  function addArvoreFinal(categoria, nomeCategoriaCustomizada = null) {
    const newArvore = {
      id: crypto.randomUUID(),
      nome: "",
      categoria: categoria,
      nomeCategoriaCustomizada: nomeCategoriaCustomizada,
      habilidades: [{ id: crypto.randomUUID(), nivel: 1, nome: "", caracteristicas: [] }],
      nivelUpDado: false,
      isCollapsed: false // New property for collapsible feature
    };

    if (categoria === "Adicional" && !nomeCategoriaCustomizada) {
        showAlertMessage("Erro", "Por favor, insira um nome para a árvore adicional.");
        return;
    }

    if (categoria === "Adicional" && nomeCategoriaCustomizada) {
        S.categoriasPersonalizadas[nomeCategoriaCustomizada] = true;
    }

    S.arvores.push(newArvore);
    save();
    hideArvoreModal();
  }
  
  function renderArvores() {
      const list = document.getElementById("lista-arvores");
      list.innerHTML = "";
      S.arvores.forEach(arvore => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `
            <div class="row arvore-header ${arvore.isCollapsed ? 'collapsed' : ''}" onclick="toggleArvore('${arvore.id}')">
              <h3>${arvore.nome || 'Árvore sem nome'}</h3>
              <div class="tag">${arvore.categoria === "Adicional" ? arvore.nomeCategoriaCustomizada : arvore.categoria}</div>
              <div class="toggle-icon">▼</div>
            </div>
            <div class="arvore-content ${arvore.isCollapsed ? 'collapsed' : ''}">
                <div class="sep"></div>
                <div id="habilidades-list-${arvore.id}" class="list ability-tree-list"></div>
                <div class="row" style="margin-top: 10px;">
                    <div class="col">
                        <label for="arvore_nome_${arvore.id}">Nome da Árvore</label>
                        <input id="arvore_nome_${arvore.id}" value="${arvore.nome}" placeholder="Ex.: Força Bruta" onchange="updateArvoreNome('${arvore.id}', this.value)" />
                    </div>
                    <button class="btn danger" onclick="deleteArvore('${arvore.id}')">Excluir Árvore</button>
                </div>
            </div>
          `;
          list.appendChild(div);
          renderHabilidades(arvore.id);
      });
  }
  
  function renderHabilidades(arvoreId) {
    const list = document.getElementById(`habilidades-list-${arvoreId}`);
    if (!list) return;
    list.innerHTML = "";
    const arvore = S.arvores.find(a => a.id === arvoreId);
    if (!arvore) return;
    arvore.habilidades.sort((a, b) => a.nivel - b.nivel);
    
    // Find all items linked to this specific tree
    const linkedItems = S.inventario.filter(item => item.arvoreVinculada === arvoreId);

    arvore.habilidades.forEach(h => {
        const li = document.createElement("div");
        li.className = "item";

        const rollBtn = document.createElement("button");
        rollBtn.className = "btn ok";
        rollBtn.innerText = "🎲 Rolar";
        // Disable the button if the ability has no name
        rollBtn.disabled = !h.nome;
        rollBtn.onclick = () => rolarHabilidade(arvore.id, h.id);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn danger";
        deleteBtn.innerText = "Excluir";
        deleteBtn.onclick = () => deleteHabilidade(arvore.id, h.id);

        const input = document.createElement("input");
        input.id = `hab_nome_${h.id}`;
        input.placeholder = "Ex.: Ataque Poderoso";
        input.value = h.nome;
        input.onchange = () => updateHabilidadeNome(arvore.id, h.id, input.value);

        const label = document.createElement("label");
        label.innerText = "Nome da Habilidade";

        const levelDiv = document.createElement("div");
        levelDiv.className = "col";
        levelDiv.style = "flex: 0 0 40px; text-align: center;";
        levelDiv.innerHTML = `<label>Nível</label><div class="val">${h.nivel}</div>`;

        const nameDiv = document.createElement("div");
        nameDiv.className = "col";
        nameDiv.appendChild(label);
        nameDiv.appendChild(input);

        const buttonRow = document.createElement("div");
        buttonRow.className = "row";
        buttonRow.appendChild(levelDiv);
        buttonRow.appendChild(nameDiv);
        buttonRow.appendChild(rollBtn);
        buttonRow.appendChild(deleteBtn);
        
        // Add item roll buttons for this ability
        if (linkedItems.length > 0) {
            linkedItems.forEach(item => {
                const itemRollBtn = document.createElement('button');
                itemRollBtn.className = 'btn';
                itemRollBtn.textContent = `🎲 Rolar com ${item.name}`;
                itemRollBtn.disabled = item.uses === 0 || item.estado === 'Quebrado';
                itemRollBtn.onclick = () => rolarHabilidadeComItem(arvore.id, h.id, item.id);
                buttonRow.appendChild(itemRollBtn);
            });
        }

        const caracsRow = document.createElement("div");
        caracsRow.className = "row wrap";
        h.caracteristicas.forEach(caracNome => {
            const arvoreCategoria = arvore.categoria === "Adicional" ? arvore.nomeCategoriaCustomizada : arvore.categoria;
            const carac = CARACTERISTICAS[arvoreCategoria]?.find(c => c.nome === caracNome);
            if (carac) {
                const btn = document.createElement('button');
                btn.className = 'tag ok';
                btn.innerText = carac.nome;
                btn.addEventListener('click', () => showCaracteristicaDetails(carac.nome, carac.descricao));
                caracsRow.appendChild(btn);
            }
        });

        const caracsDiv = document.createElement("div");
        caracsDiv.className = "col";
        caracsDiv.style = "flex: 100%;";
        caracsDiv.innerHTML = `<label>Características</label>`;
        caracsDiv.appendChild(caracsRow);

        li.appendChild(buttonRow);
        li.appendChild(caracsDiv);
        
        const resultArea = document.createElement("div");
        resultArea.id = `hab-result-${h.id}`;
        resultArea.className = "item-result-area";
        li.appendChild(resultArea);

        list.appendChild(li);

        // FIX: Display the last roll if it exists
        if (h.lastRoll) {
            desenharRolagem(resultArea.id, h.lastRoll, false, arvoreId, h.id);
        }
    });
  }

  function updateArvoreNome(id, nome) {
      const arvore = S.arvores.find(a => a.id === id);
      if (arvore) {
          arvore.nome = nome;
          save();
      }
  }

  function updateHabilidadeNome(arvoreId, habId, nome) {
      const habilidade = findHabilidade(arvoreId, habId);
      if (habilidade) {
          habilidade.nome = nome;
          save();
      }
  }

  function deleteArvore(id) {
      const arvore = S.arvores.find(a => a.id === id);
      if (arvore && arvore.categoria === "Adicional" && arvore.nomeCategoriaCustomizada) {
          delete S.categoriasPersonalizadas[arvore.nomeCategoriaCustomizada];
      }
      S.arvores = S.arvores.filter(a => a.id !== id);
      save();
  }

  function deleteHabilidade(arvoreId, habId) {
      const arvore = S.arvores.find(a => a.id === arvoreId);
      if (arvore) {
          arvore.habilidades = arvore.habilidades.filter(h => h.id !== habId);
          if (arvore.habilidades.length === 0) {
              S.arvores = S.arvores.filter(a => a.id !== arvoreId);
          }
          save();
      }
  }

  function findHabilidade(arvoreId, habId) {
      const arvore = S.arvores.find(a => a.id === arvoreId);
      if (!arvore) return null;
      return arvore.habilidades.find(h => h.id === habId);
  }

  function findCaracteristica(categoria, nomeCategoriaCustomizada, caracNome) {
      const displayCategory = categoria === "Adicional" ? nomeCategoriaCustomizada : categoria;
      const list = CARACTERISTICAS[displayCategory] || [];
      return list.find(c => c.nome === caracNome);
  }

  function showCaracteristicaDetails(caracNome, caracDesc) {
      showAlertMessage(caracNome, caracDesc);
  }

  function showAllCaracteristicasModal() {
      const modal = document.getElementById('all-caracteristicas-modal');
      const list = document.getElementById('all-caracteristicas-list');
      list.innerHTML = "";
      
      const allCategories = [...CATEGORIAS_PADRAO, ...Object.keys(S.categoriasPersonalizadas)];
      allCategories.forEach(category => {
          const charList = CARACTERISTICAS[category];
          if (charList && charList.length > 0) {
              const h4 = document.createElement("h4");
              h4.innerText = `Categoria: ${category}`;
              list.appendChild(h4);
              charList.forEach(c => {
                  const div = document.createElement("div");
                  div.className = "item";
                  div.innerHTML = `
                      <h4>${c.nome}</h4>
                      <div class="muted">${c.descricao}</div>
                  `;
                  list.appendChild(div);
              });
          }
      });
      modal.style.display = 'flex';
  }
  
  function hideAllCaracteristicasModal() {
      document.getElementById('all-caracteristicas-modal').style.display = 'none';
  }

  function renderCaracteristicaModal() {
      const modal = document.getElementById('caracteristica-modal');
      const optionsContainer = document.getElementById('caracteristica-options');
      optionsContainer.innerHTML = "";
      
      const { arvoreId, habId, categoria, nomeCategoriaCustomizada } = habilidadeParaCaracteristica;
      const displayCategory = categoria === "Adicional" ? nomeCategoriaCustomizada : categoria;
      
      if (!CARACTERISTICAS[displayCategory]) {
          showAlertMessage("Erro", "Nenhuma característica definida para esta categoria.");
          return;
      }
      
      CARACTERISTICAS[displayCategory].forEach(c => {
          const button = document.createElement("button");
          button.className = "btn ok";
          button.innerHTML = `
              <div style="text-align: left;">
                  <b>${c.nome}</b>
                  <div class="muted small" style="font-weight: normal;">${c.descricao}</div>
              </div>
          `;
          button.onclick = () => {
              const habilidade = findHabilidade(arvoreId, habId);
              if (habilidade) {
                  habilidade.caracteristicas.push(c.nome);
                  save();
                  showAlertMessage("Característica Adicionada", `A característica "${c.nome}" foi adicionada a "${habilidade.nome}".`);
              }
              cancelarEscolha();
          };
          optionsContainer.appendChild(button);
      });
      
      modal.style.display = 'flex';
  }

  function openManualCaracModal() {
    document.getElementById('manual-carac-modal').style.display = 'flex';
    renderManualCaracSelection();
  }

  function hideManualCaracModal() {
    document.getElementById('manual-carac-modal').style.display = 'none';
  }
  
  function renderManualCaracSelection() {
      const arvoreSelect = document.getElementById('manual_arvore_carac');
      const habSelect = document.getElementById('manual_hab_carac');
      arvoreSelect.innerHTML = '<option value="">- Selecione -</option>';
      habSelect.innerHTML = '<option value="">- Selecione -</option>';
      
      S.arvores.forEach(arvore => {
          const option = document.createElement("option");
          option.value = arvore.id;
          option.innerText = `${arvore.nome || 'Árvore sem nome'} (${arvore.categoria === "Adicional" ? arvore.nomeCategoriaCustomizada : arvore.categoria})`;
          arvoreSelect.appendChild(option);
      });

      arvoreSelect.onchange = () => {
          const arvore = S.arvores.find(a => a.id === arvoreSelect.value);
          habSelect.innerHTML = '<option value="">- Selecione -</option>';
          if (arvore) {
              arvore.habilidades.forEach(hab => {
                  const option = document.createElement("option");
                  option.value = hab.id;
                  option.innerText = `${hab.nome || `Habilidade de Nível ${hab.nivel}`}`;
                  habSelect.appendChild(option);
              });
          }
          renderManualCaracOptions();
      };

      habSelect.onchange = renderManualCaracOptions;
  }
  
  function renderManualCaracOptions() {
    const arvoreId = document.getElementById('manual_arvore_carac').value;
    const habId = document.getElementById('manual_hab_carac').value;
    const optionsContainer = document.getElementById('manual-carac-options');
    optionsContainer.innerHTML = "";
    
    if (!arvoreId || !habId) return;

    const arvore = S.arvores.find(a => a.id === arvoreId);
    if (!arvore) return;
    const habilidade = findHabilidade(arvoreId, habId);
    if (!habilidade) return;

    const displayCategory = arvore.categoria === "Adicional" ? arvore.nomeCategoriaCustomizada : arvore.categoria;
    
    if (!CARACTERISTICAS[displayCategory]) {
        optionsContainer.innerHTML = `<p class="muted">Nenhuma característica definida para esta categoria.</p>`;
        return;
    }
    
    CARACTERISTICAS[displayCategory].forEach(c => {
        const button = document.createElement("button");
        button.className = "btn ok";
        button.innerHTML = `
            <div style="text-align: left;">
                <b>${c.nome}</b>
                <div class="muted small" style="font-weight: normal;">${c.descricao}</div>
            </div>
        `;
        button.onclick = () => {
            addCaracteristicaToHabilidade(arvoreId, habId, c.nome);
            hideManualCaracModal();
            hideManualModal();
        };
        optionsContainer.appendChild(button);
    });
  }

  function addCaracteristicaToHabilidade(arvoreId, habId, caracNome) {
      const habilidade = findHabilidade(arvoreId, habId);
      if (habilidade) {
          habilidade.caracteristicas.push(caracNome);
          save();
          showAlertMessage("Característica Adicionada", `A característica "${caracNome}" foi adicionada a "${habilidade.nome}".`);
      }
  }

  function cancelarEscolha() {
      document.getElementById('caracteristica-modal').style.display = 'none';
      habilidadeParaCaracteristica = null;
  }
  
  function showManualModal() {
    document.getElementById('manual-modal').style.display = 'flex';
    renderManualSelection();
  }
  
  function hideManualModal() {
    document.getElementById('manual-modal').style.display = 'none';
  }

  function renderManualSelection() {
      const arvoreSelect = document.getElementById('manual_arvore');
      arvoreSelect.innerHTML = '<option value="">- Selecione -</option>';
      S.arvores.forEach(arvore => {
          const option = document.createElement("option");
          option.value = arvore.id;
          option.innerText = `${arvore.nome || 'Árvore sem nome'} (${arvore.categoria === "Adicional" ? arvore.nomeCategoriaCustomizada : arvore.categoria})`;
          arvoreSelect.appendChild(option);
      });
      checkManualOptions();
  }

  function checkManualOptions() {
      const arvoreId = document.getElementById('manual_arvore').value;
      const arvore = S.arvores.find(a => a.id === arvoreId);
      const optionsDiv = document.getElementById('manual-options');
      if (arvore) {
          optionsDiv.style.display = 'flex';
          const btnAddLevel = document.getElementById('btn-add-level');
          const btnAddCarac = document.getElementById('btn-add-carac');
          const maxNivel = arvore.habilidades.length > 0 ? Math.max(...arvore.habilidades.map(h => h.nivel)) : 0;
          
          btnAddLevel.style.display = maxNivel < 6 ? 'inline-flex' : 'none';
          btnAddCarac.style.display = 'inline-flex';
      } else {
          optionsDiv.style.display = 'none';
      }
  }

  function addLevelManually() {
      const arvoreId = document.getElementById('manual_arvore').value;
      const arvore = S.arvores.find(a => a.id === arvoreId);
      if (!arvore) return;
      
      const maxNivel = arvore.habilidades.length > 0 ? Math.max(...arvore.habilidades.map(h => h.nivel)) : 0;
      if (maxNivel < 6) {
          const newLevel = maxNivel + 1;
          arvore.habilidades.push({ id: crypto.randomUUID(), nivel: newLevel, nome: "", caracteristicas: [] });
          arvore.habilidades.sort((a, b) => a.nivel - b.nivel);
          save();
          hideManualModal();
      } else {
          showAlertMessage("Erro", "Esta árvore já atingiu o nível máximo (6).");
      }
  }
  
  // ======== FUNÇÕES DE INVENTÁRIO ========
  
  function renderArvoreSelection(selectedCat) {
    const catStdSelect = document.getElementById('i_cat_std');
    const catCustomSelect = document.getElementById('i_cat_custom');
    const arvoreVinculadaCustomSelect = document.getElementById('arvore_vinculada_custom');
    const arvoreVinculadaEditSelect = document.getElementById('arvore_vinculada_edit');
    
    // Clear previous options
    if (catStdSelect) catStdSelect.innerHTML = '';
    if (catCustomSelect) catCustomSelect.innerHTML = '';
    if (arvoreVinculadaCustomSelect) arvoreVinculadaCustomSelect.innerHTML = '<option value="">- Nenhum -</option>';
    if (arvoreVinculadaEditSelect) arvoreVinculadaEditSelect.innerHTML = '<option value="">- Nenhum -</option>';

    const categories = getCategories();
    categories.forEach(cat => {
      const optStd = document.createElement('option');
      optStd.value = cat; optStd.innerText = cat;
      if (catStdSelect) catStdSelect.appendChild(optStd);
      const optCustom = document.createElement('option');
      optCustom.value = cat; optCustom.innerText = cat;
      if (catCustomSelect) catCustomSelect.appendChild(optCustom);
    });

    S.arvores.forEach(arvore => {
      const option = document.createElement("option");
      option.value = arvore.id;
      option.innerText = `${arvore.nome || 'Árvore sem nome'} (${arvore.categoria === "Adicional" ? arvore.nomeCategoriaCustomizada : arvore.categoria})`;
      
      const arvoreCat = arvore.categoria === 'Adicional' ? arvore.nomeCategoriaCustomizada : arvore.categoria;
      
      // Filter the options for the edit modal based on the item's category
      if (arvoreVinculadaEditSelect && selectedCat && arvoreCat === selectedCat) {
        arvoreVinculadaEditSelect.appendChild(option.cloneNode(true));
      }
      
      if (arvoreVinculadaCustomSelect) arvoreVinculadaCustomSelect.appendChild(option.cloneNode(true));
    });
  }
  
  function renderItens() {
    const list = document.getElementById('lista-itens');
    list.innerHTML = '';
    S.inventario.forEach(item => {
      const div = document.createElement('div');
      div.className = 'item';
      div.id = `item-container-${item.id}`;
      let tagsHtml = `<span class="tag">${item.category}</span>`;
      if (item.estado === "Danificado") tagsHtml += `<span class="tag warn">Danificado</span>`;
      if (item.estado === "Quebrado") tagsHtml += `<span class="tag bad">Quebrado</span>`;
      
      const arvore = S.arvores.find(a => a.id === item.arvoreVinculada);
      const arvoreVinculadaInfo = arvore ? `<div class="muted small">Vínculo: ${arvore.nome || 'Árvore sem nome'}</div>` : '<div class="muted small">Vínculo: Nenhum</div>';

      const editarBtn = document.createElement('button');
      editarBtn.className = 'btn ghost';
      editarBtn.textContent = '✏️ Editar';
      editarBtn.onclick = () => editItem(item.id);

      const excluirBtn = document.createElement('button');
      excluirBtn.className = 'btn danger';
      excluirBtn.textContent = '🗑️ Excluir';
      excluirBtn.onclick = () => deleteItem(item.id);

      const itemDetailsHtml = `
          <h4>${item.name} ${tagsHtml}</h4>
          <div class="muted small">Nível ${item.level} • Usos: ${item.uses} • Bônus: +${item.bonus}D6</div>
          ${arvoreVinculadaInfo}
          <div class="muted small" style="margin-top: 4px;">Efeito: ${item.effect}</div>
      `;

      div.innerHTML = itemDetailsHtml;
      
      const actionsDiv = document.createElement('div');
      actionsDiv.className = 'actions';
      actionsDiv.style.marginTop = '8px';
      actionsDiv.appendChild(editarBtn);
      actionsDiv.appendChild(excluirBtn);
      
      list.appendChild(div);
    });

    renderArvoreSelection();
    updateItemCost();
    updateCustomItemStats();
  }

  function rolarItem(id) {
    const item = S.inventario.find(i => i.id === id);
    if (!item || item.estado === 'Quebrado' || item.uses <= 0 || !item.arvoreVinculada) {
        showAlertMessage("Erro", "O item não pode ser usado.");
        return;
    }

    clearAllRollResults();

    let nivelBase = 1;
    let arvore = S.arvores.find(a => a.id === item.arvoreVinculada);
    if (arvore && arvore.habilidades.length > 0) {
        nivelBase = Math.max(...arvore.habilidades.map(h => h.nivel));
    }
    
    const totalDados = nivelBase + item.bonus;

    const rollData = {
      resultados: rolarND6(totalDados),
      meta: {
        origem: `Item: ${item.name}`,
        nRolados: totalDados,
        nBase: nivelBase,
        bonusItem: item.bonus,
        nivelHabilidade: nivelBase,
        categoria: item.category,
        itemId: id
      }
    };
    
    item.lastRoll = rollData;
    usarItem(id);

    save();
  }

  function usarItem(id) {
    const item = S.inventario.find(i => i.id === id);
    if (item && item.uses > 0) {
      item.uses--;
      if (item.uses === 0) {
          item.estado = "Danificado";
      }
      save();
    }
  }
  
  function resetarUsosItem(id) {
      const item = S.inventario.find(i => i.id === id);
      if (item) {
          item.uses = ITEM_TABLE[item.level].uses;
          item.estado = "Normal";
          save();
      }
  }
  
  function updateItemCost() {
    const lvl = document.getElementById('i_lvl_std').value;
    const itemData = ITEM_TABLE[lvl];
    document.getElementById('i_cost_val').innerText = itemData.xp;
  }

  function updateCustomItemStats() {
    const lvl = document.getElementById('i_lvl_custom').value;
    const itemData = ITEM_TABLE[lvl];
    document.getElementById('i_usos_custom').innerText = itemData.uses;
    document.getElementById('i_bonus_custom').innerText = itemData.bonus;
    updateCustomItemCost();
  }

  function updateCustomItemCost() {
    const isLoot = document.getElementById('loot-toggle').checked;
    const lvl = document.getElementById('i_lvl_custom').value;
    const itemData = ITEM_TABLE[lvl];
    document.getElementById('i_xp_custom').innerText = isLoot ? 0 : itemData.xp;
  }
  
  function addStandardItem() {
    const cat = document.getElementById('i_cat_std').value;
    const lvl = document.getElementById('i_lvl_std').value;
    const cost = parseInt(document.getElementById('i_cost_val').innerText);

    if (S.personagem.xp < cost) {
      showAlertMessage("XP Insuficiente", "Você não tem XP suficiente para comprar este item.");
      return;
    }

    S.personagem.xp -= cost;
    S.personagem.xpHistory.push({ amount: -cost, reason: `Compra de Item: ${cat} Nvl ${lvl}`, date: new Date().toISOString() });
    
    const newItem = {
      id: crypto.randomUUID(),
      name: `Item ${cat} Nível ${lvl}`,
      category: cat,
      level: parseInt(lvl),
      uses: ITEM_TABLE[lvl].uses,
      bonus: ITEM_TABLE[lvl].bonus,
      effect: ITEM_TABLE[lvl].fx,
      estado: "Normal",
      arvoreVinculada: null
    };

    const arvore = S.arvores.find(a => a.categoria === cat || a.nomeCategoriaCustomizada === cat);
    if (arvore) {
        newItem.arvoreVinculada = arvore.id;
    }

    S.inventario.push(newItem);
    save();
    showAlertMessage("Item Adicionado", `Você comprou um ${newItem.name}.`);
  }

  function addCustomItem() {
    const isLoot = document.getElementById('loot-toggle').checked;
    const name = document.getElementById('i_nome_custom').value;
    const cat = document.getElementById('i_cat_custom').value;
    const lvl = parseInt(document.getElementById('i_lvl_custom').value);
    const uses = parseInt(document.getElementById('i_usos_custom').innerText);
    const bonus = parseInt(document.getElementById('i_bonus_custom').innerText);
    const fx = document.getElementById('i_fx_custom').value;
    const cost = isLoot ? 0 : parseInt(document.getElementById('i_xp_custom').innerText);
    const arvoreVinculadaId = document.getElementById('arvore_vinculada_custom').value || null;

    if (!name.trim() || !cat) {
      showAlertMessage("Erro", "Nome e Categoria são obrigatórios.");
      return;
    }

    if (!isLoot && S.personagem.xp < cost) {
      showAlertMessage("XP Insuficiente", "Você não tem XP suficiente para comprar este item.");
      return;
    }
    
    if (!isLoot) {
        S.personagem.xp -= cost;
        S.personagem.xpHistory.push({ amount: -cost, reason: `Compra de Item Personalizado: ${name}`, date: new Date().toISOString() });
    }

    const newItem = {
      id: crypto.randomUUID(),
      name,
      category: cat,
      level: lvl,
      uses,
      bonus,
      fx,
      estado: "Normal",
      arvoreVinculada: arvoreVinculadaId
    };

    S.inventario.push(newItem);
    document.getElementById('i_nome_custom').value = "";
    document.getElementById('i_fx_custom').value = "";
    if (document.getElementById('arvore_vinculada_custom')) {
      document.getElementById('arvore_vinculada_custom').value = "";
    }
    save();
    showAlertMessage("Item Adicionado", `O item "${name}" foi adicionado ao seu inventário.`);
  }

  function quickAddSample() {
      document.getElementById('i_nome_custom').value = "Espada Mágica";
      document.getElementById('i_cat_custom').value = "Ataque";
      document.getElementById('i_lvl_custom').value = "3";
      updateCustomItemStats();
      document.getElementById('i_fx_custom').value = "+3D6 ao atacar. Quando a lâmina brilha, recupera 1 PV por 6 rolado.";
  }

  function editItem(id) {
      const item = S.inventario.find(i => i.id === id);
      if (!item) return;
      editingItemId = id;
      document.getElementById('edit_nome').value = item.name;
      document.getElementById('edit_lvl').value = item.level;
      document.getElementById('edit_usos').value = item.uses;
      document.getElementById('edit_bonus').value = item.bonus;
      document.getElementById('edit_fx').value = item.fx;
      renderArvoreSelection(item.category);
      document.getElementById('arvore_vinculada_edit').value = item.arvoreVinculada || "";
      document.getElementById('edit-item-modal').style.display = 'flex';
  }

  function hideEditItemModal() {
      document.getElementById('edit-item-modal').style.display = 'none';
      editingItemId = null;
  }

  function salvarEdicaoItem() {
      if (!editingItemId) return;
      const item = S.inventario.find(i => i.id === editingItemId);
      if (item) {
          item.name = document.getElementById('edit_nome').value;
          item.level = parseInt(document.getElementById('edit_lvl').value);
          item.uses = parseInt(document.getElementById('edit_usos').value);
          item.bonus = parseInt(document.getElementById('edit_bonus').value);
          item.fx = document.getElementById('edit_fx').value;
          item.arvoreVinculada = document.getElementById('arvore_vinculada_edit').value || null;
          save();
      }
      hideEditItemModal();
  }
  
  function deleteItem(id) {
      S.inventario = S.inventario.filter(i => i.id !== id);
      save();
  }
  
  // ======== EXPORT / IMPORT / RESET ========
  function exportar() {
    const data = JSON.stringify(S, null, 2);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${S.personagem.nome || "ficha-alfa"}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function importar(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const importedState = JSON.parse(event.target.result);
        if (importedState.personagem && importedState.arvores && importedState.inventario) {
          S = importedState;
          save();
          showAlertMessage("Ficha Importada", "Ficha importada com sucesso!");
        } else {
          showAlertMessage("Erro de Importação", "O arquivo JSON não é um formato de ficha válido.");
        }
      } catch (error) {
        showAlertMessage("Erro de Importação", "Ocorreu um erro ao ler o arquivo. Certifique-se de que é um JSON válido.");
      }
    };
    reader.readAsText(file);
  }

  function resetar() {
    if (confirm("Tem certeza? Isso apagará toda a sua ficha!")) {
      localStorage.removeItem(STATE_KEY);
      window.location.reload();
    }
  }

  // ======== GERAR PDF ========
  function gerarPdfFicha() {
    const { jsPDF } = window.jspdf;
    
    // Mapear dados para o PDF
    document.getElementById('print-nome').innerText = S.personagem.nome || '-';
    document.getElementById('print-raca').innerText = S.personagem.raca || '-';
    document.getElementById('print-classe').innerText = S.personagem.classe || '-';
    document.getElementById('print-nivel').innerText = S.personagem.nivel;
    document.getElementById('print-xp').innerText = S.personagem.xp;
    document.getElementById('print-pv').innerText = `${S.personagem.pv_atual} / ${S.personagem.pv_max}`;
    document.getElementById('print-ps').innerText = `${S.personagem.ps_atual} / ${S.personagem.ps_max}`;
    document.getElementById('print-escudos').innerText = `${S.personagem.escudos} / ${S.personagem.pv_max}`;
    document.getElementById('print-notas').innerText = S.personagem.conceito + '\n\n' + S.personagem.notas;

    // Foto de perfil
    if (S.personagem.fotoUrl) {
      const imgEl = document.getElementById('print-foto-img');
      imgEl.src = S.personagem.fotoUrl;
      const transform = S.personagem.imageTransform;
      imgEl.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
    } else {
      document.getElementById('print-foto-img').src = "https://placehold.co/100x100";
      document.getElementById('print-foto-img').style.transform = 'translate(0, 0) scale(1)';
    }

    // Listar Árvores
    const printArvores = document.getElementById('print-arvores-list');
    printArvores.innerHTML = S.arvores.map(arvore => `
      <div style="margin-bottom: 10px;">
        <h4 style="margin: 0; font-size: 14px;">${arvore.nome || 'Árvore sem nome'} (${arvore.categoria === "Adicional" ? arvore.nomeCategoriaCustomizada : arvore.categoria})</h4>
        <ul style="margin: 4px 0 0 0; padding: 0 0 0 20px;">
          ${arvore.habilidades.map(h => `
            <li style="font-size: 12px; margin-bottom: 2px;">
              <b>N${h.nivel}</b>: ${h.nome || 'Habilidade sem nome'}
              ${h.caracteristicas.length > 0 ? `(${h.caracteristicas.join(', ')})` : ''}
            </li>
          `).join('')}
        </ul>
      </div>
    `).join('');

    // Listar Itens
    const printItens = document.getElementById('print-itens-list');
    printItens.innerHTML = S.inventario.map(item => `
      <div style="margin-bottom: 10px;">
        <h4 style="margin: 0; font-size: 14px;">${item.name} (${item.category})</h4>
        <p style="margin: 4px 0 0 0; font-size: 12px;">
          Nível ${item.level} • Usos: ${item.uses} • Bônus: +${item.bonus}D6
          ${item.estado !== 'Normal' ? ` • Estado: <b>${item.estado}</b>` : ''}
        </p>
        <p style="margin: 4px 0 0 0; font-size: 12px;">Efeito: ${item.effect}</p>
      </div>
    `).join('');

    // Esconder a tela principal e mostrar a de impressão
    document.getElementById('ficha-geral').style.display = 'none';
    document.getElementById('printable-content').style.display = 'block';

    const element = document.getElementById('printable-content');
    html2canvas(element, { scale: 2 }).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const doc = new jsPDF('p', 'mm', 'a4');
      const imgProps= doc.getImageProperties(imgData);
      const pdfWidth = doc.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      doc.save(`${S.personagem.nome || "ficha-alfa"}.pdf`);

      // Restaurar a visualização
      document.getElementById('ficha-geral').style.display = 'grid';
      document.getElementById('printable-content').style.display = 'none';
    });
  }
  
  // Função para fazer a chamada à API do Gemini
  async function generateContentWithGemini() {
      const prompt = document.getElementById('gemini_prompt').value;
      if (!prompt) {
          showAlertMessage("Erro", "Por favor, insira uma descrição para gerar o conteúdo.");
          return;
      }
      
      const resultArea = document.getElementById('gemini-result');
      const resultText = document.getElementById('gemini-result-text');
      const loadingEl = document.getElementById('gemini-loading');
      
      resultArea.style.display = 'none';
      loadingEl.style.display = 'block';
      
      // Adiciona uma instrução no prompt para que a resposta seja em português
      const finalPrompt = `Responda em português brasileiro. ${prompt}`;
      
      // Construir o payload para a API
      const chatHistory = [];
      chatHistory.push({ role: "user", parts: [{ text: finalPrompt }] });
      const payload = { 
          contents: chatHistory,
      };
      const apiKey = ""
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

      let attempts = 0;
      const maxAttempts = 3;
      let delay = 1000;
      let response;
      let result;

      while (attempts < maxAttempts) {
          try {
              response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
              });

              if (response.ok) {
                  result = await response.json();
                  break; // Sai do loop se a resposta for bem-sucedida
              } else if (response.status === 429) {
                  // Lidar com o erro de "Too Many Requests" com backoff
                  attempts++;
                  await new Promise(res => setTimeout(res, delay));
                  delay *= 2; // Aumenta o tempo de espera
                  continue; // Tentar novamente
              } else {
                  // Outros erros
                  const errorText = await response.text();
                  throw new Error(`Erro na API: ${response.status} - ${errorText}`);
              }
          } catch (error) {
              attempts++;
              if (attempts >= maxAttempts) {
                  loadingEl.style.display = 'none';
                  resultArea.style.display = 'block';
                  resultText.innerText = `Erro ao gerar conteúdo: ${error.message}`;
                  return;
              }
              await new Promise(res => setTimeout(res, delay));
              delay *= 2;
          }
      }

      loadingEl.style.display = 'none';
      resultArea.style.display = 'block';
      
      if (result.candidates && result.candidates.length > 0 &&
          result.candidates[0].content && result.candidates[0].content.parts &&
          result.candidates[0].content.parts.length > 0) {
        resultText.innerText = result.candidates[0].content.parts[0].text;
      } else {
        resultText.innerText = "Não foi possível gerar conteúdo. A resposta da API está vazia.";
      }
  }

  // Carrega a ficha ao iniciar
  window.onload = load;
</script>
</body>
</html>
